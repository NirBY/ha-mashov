# --------------------------------------------
# Mashov – Weekly timetable + plan + holidays (template)
# --------------------------------------------
# WHAT THIS CARD DOES
# - Base grid from the student's TIMETABLE (day+lesson → subject/teacher).
# - Joins the WEEKLY PLAN sensor by matching day+lesson and shows "תכנון לשיעור".
# - Marks HOLIDAY dates (from sensor.mashov_holidays) with red header and soft red cells,
#   and prints holiday name(s) under the date.
# - RTL, Sunday-first, lesson numbers are the rows, current day highlighted.
#
# HOW TO USE / WHAT TO CHANGE
# - Replace <studentID> in BOTH entity IDs below:
#     sensor.mashov_<studentID>_timetable
#     sensor.mashov_<studentID>_weekly_plan
# - If your holidays sensor has a different id, change sensor.mashov_holidays accordingly.
#
# DEPENDENCIES (Lovelace resources)
# - custom:config-template-card   (HACS)  → add resource, then use type: module
# - custom:html-card              (HACS)  → add resource, then use type: module
#   In Settings → Dashboards → Resources, you should have e.g.:
#   /hacsfiles/config-template-card/config-template-card.js  (module)
#   /hacsfiles/html-card/html-card.js                        (module)
#
# DATA EXPECTED
# - Timetable sensor attributes: Items[].timeTable.{day(1-7), lesson}, groupDetails.{subjectName, groupTeachers[].teacherName}
# - Weekly plan sensor attributes: Items[].{lesson_date (ISO), lesson, plan}
# - Holidays sensor attributes: Items[].{name, start(ISO), end(ISO)}; ranges are inclusive of both dates.
#
type: custom:config-template-card
entities:
  - sensor.mashov_<studentID>_timetable
  - sensor.mashov_<studentID>_weekly_plan
  - sensor.mashov_holidays
card:
  type: custom:html-card
  content: >-
    ${(function(){var TT='sensor.mashov_<studentID>_timetable',WP='sensor.mashov_<studentID>_weekly_plan',HL='sensor.mashov_holidays',tt=states[TT],wp=states[WP],hl=states[HL];if(!tt||!tt.attributes){return '<div dir="rtl" style="text-align:right;padding:8px;opacity:.8;">אין נתונים להצגה</div>'; }function pad(n){return String(n).padStart(2,'0');}function fmt(d){return pad(d.getDate())+'/'+pad(d.getMonth()+1)+'/'+d.getFullYear();}function ymd(d){return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate());}function at0(d){return new Date(d.getFullYear(),d.getMonth(),d.getDate(),0,0,0,0);}var student=(tt.attributes.student_name||tt.attributes['Student name']||tt.attributes.full_name||tt.attributes.name||(tt.attributes.friendly_name||'').trim()||'שם תלמיד/ה');var ttItems=Array.isArray(tt.attributes.Items||tt.attributes.items)?(tt.attributes.Items||tt.attributes.items):[];var wpItems=(wp&&wp.attributes&&Array.isArray(wp.attributes.Items||wp.attributes.items))?(wp.attributes.Items||wp.attributes.items):[];var hlItems=(hl&&hl.attributes&&Array.isArray(hl.attributes.Items||hl.attributes.items))?(hl.attributes.Items||hl.attributes.items):[];var today=new Date(),dow=today.getDay(),weekStart=new Date(today.getFullYear(),today.getMonth(),today.getDate()-dow),baseSunday=new Date(weekStart);var days=[];for(var i=-28;i<=28;i++){var d=new Date(baseSunday);d.setDate(baseSunday.getDate()+i);days.push(d);}var BASE=28,startIdx=(dow===6?(BASE+7):BASE+dow);var baseGrid={},lessonSet={};for(var k=0;k<ttItems.length;k++){var it=ttItems[k]||{},t=it.timeTable||it.timetable||{};var di=(parseInt(t.day,10)||0)-1;if(di<0||di>6)continue;var les=(t.lesson!=null?String(t.lesson):'');if(!les)continue;var gd=it.groupDetails||{},subj=(gd.subjectName||gd.groupName||''),teacher=((gd.groupTeachers&&gd.groupTeachers[0]&&gd.groupTeachers[0].teacherName)||'');var label=subj?('<b>'+subj+'</b>'+(teacher?'<br>'+teacher:'')):(teacher||'');(baseGrid[di]||(baseGrid[di]={}))[les]=label;lessonSet[les]=1;}var lessons=Object.keys(lessonSet).map(x=>parseInt(x,10)).filter(x=>!isNaN(x)).sort((a,b)=>a-b).map(String);if(!lessons.length){return '<div dir="rtl" style="text-align:right;padding:8px;opacity:.8;">אין מערכת שעות להצגה</div>'; }var plansByDay={},holByDay={};for(var p=0;p<wpItems.length;p++){var w=wpItems[p]||{};var ds=w.lesson_date||w.date||'';if(!ds)continue;var ky=ymd(at0(new Date(ds)));var l2=(w.lesson!=null?String(w.lesson):''),pl=(w.plan!=null?String(w.plan):'');if(!l2||!pl)continue;((plansByDay[ky]||(plansByDay[ky]={}))[l2]||(plansByDay[ky][l2]=[])).push(pl);}for(var h=0;h<hlItems.length;h++){var H=hlItems[h]||{},nm=H.name||'';var st=H.start?at0(new Date(H.start)):null,en=H.end?at0(new Date(H.end)):null;if(!st||!en)continue;for(var i2=0;i2<days.length;i2++){var x=at0(days[i2]);if(x>=st&&x<=en){var key=ymd(x);(holByDay[key]||(holByDay[key]=[])).includes(nm)||holByDay[key].push(nm);}}}var isDark=false;try{isDark=window.matchMedia&&window.matchMedia('(prefers-color-scheme: dark)').matches;}catch(e){}function headBg(d){var ky=ymd(at0(d));var isHol=(holByDay[ky]||[]).length>0;var isToday=(ymd(at0(d))===ymd(at0(today)));if(isDark){return isHol?'#5c2b2b':(isToday?'#4a430e':'#2b2b2b');}return isHol?'#ffcdd2':(isToday?'#fff59d':'#f1f1f1');}function cellBg(d){var ky=ymd(at0(d));var isHol=(holByDay[ky]||[]).length>0;var isToday=(ymd(at0(d))===ymd(at0(today)));if(isDark){return isHol?'#442b30':(isToday?'#3a3614':'#1e1e1e');}return isHol?'#ffe5e8':(isToday?'#fff9c4':'#ffffff');}var hasBaseByDOW=[];for(var dwi=0;dwi<7;dwi++){hasBaseByDOW[dwi]=!!(baseGrid[dwi]&&Object.keys(baseGrid[dwi]).length);}function hasAnyData(d){var ky=ymd(at0(d));return hasBaseByDOW[d.getDay()]||(plansByDay[ky]&&Object.keys(plansByDay[ky]).length)||((holByDay[ky]||[]).length);}var pairStarts=[];for(var off=-20;off<=20;off+=2){var s=startIdx+off;if(s>=1&&s<=days.length-2){var d1=days[s],d2=days[s+1];if(hasAnyData(d1)||hasAnyData(d2))pairStarts.push(s);}}function ensure(dir,need){for(var m=2;m<=need;m+=2){var s=startIdx+(dir>0?m:-m);if(s<1||s>days.length-2)break;var d1=days[s],d2=days[s+1];if(hasAnyData(d1)||hasAnyData(d2)){if(!pairStarts.includes(s))pairStarts.push(s);}}}ensure(-1,8);ensure(1,8);pairStarts.sort((a,b)=>a-b);var def=pairStarts.indexOf(startIdx);if(def<0){var best=0,dist=1e9;for(var i3=0;i3<pairStarts.length;i3++){var d=Math.abs(pairStarts[i3]-startIdx);if(d<dist){dist=d;best=i3;}}def=best;}var rid='mx_'+Math.random().toString(36).slice(2),dayNames=['ראשון','שני','שלישי','רביעי','חמישי','שישי','שבת'];var css='<style>.mx-wrap{position:relative;isolation:isolate;color-scheme:'+(isDark?'dark':'light')+';forced-color-adjust:none!important}.mx-head{margin:0 0 8px;font-size:16px;text-align:right}.mx-frame{border:1px solid '+(isDark?'#2a2a2a':'#e0e0e0')+';border-radius:10px;padding:8px 10px;isolation:isolate;color-scheme:'+(isDark?'dark':'light')+';forced-color-adjust:none!important;background:'+(isDark?'#111111':'transparent')+'}.grid{display:grid;grid-template-columns:96px 1fr 1fr;gap:0;border:0;contain:paint;position:relative;z-index:0}.cell{position:relative;z-index:1;border-bottom:1px solid '+(isDark?'#2a2a2a':'#dddddd')+';padding:10px 12px;min-height:24px;background:'+(isDark?'#1e1e1e':'#ffffff')+';color:'+(isDark?'#eaeaea':'#111111')+';word-break:normal;overflow-wrap:anywhere;mix-blend-mode:normal;color-scheme:'+(isDark?'dark':'light')+';forced-color-adjust:none!important}.head{border-bottom:1px solid '+(isDark?'#3a3a3a':'#cccccc')+';font-weight:600;white-space:nowrap}.lesson{background:'+(isDark?'#1e1e1e':'#ffffff')+';border-inline-end:1px solid '+(isDark?'#3a3a3a':'#cccccc')+'}.pair{display:none;contain:paint;position:relative;z-index:0}.mx-nav{display:flex;justify-content:space-between;gap:12px;margin-top:10px}.mx-btn{cursor:pointer;user-select:none;padding:6px 12px;border:1px solid '+(isDark?'#4a4a4a':'#bdbdbd')+';border-radius:8px;background:'+(isDark?'#1e1e1e':'#ffffff')+';color:'+(isDark?'#eaeaea':'#111111')+';color-scheme:'+(isDark?'dark':'light')+';forced-color-adjust:none!important}';for(var i=0;i<pairStarts.length;i++){css+='#'+rid+'_p'+i+':checked ~ .mx-view .pair-'+i+'{display:block} #'+rid+'_p'+i+':checked ~ .mx-nav .prev-'+i+',#'+rid+'_p'+i+':checked ~ .mx-nav .next-'+i+'{display:inline-flex} ';}css+='.mx-nav .mx-btn{display:none}</style>';function mk(base,plans){var c='';if(base)c+='<div>'+base+'</div>';if(plans&&plans.length===1)c+='<div style="margin-top:4px;"><b>תכנון לשיעור:</b><br>'+plans[0]+'</div>';else if(plans&&plans.length>1)c+='<div style="margin-top:4px;"><b>תכנון לשיעור:</b><br>• '+plans.join('<br>• ')+'</div>';return c||'&nbsp;';}function gridFor(d1,d2){var ky1=ymd(at0(d1)),ky2=ymd(at0(d2));var hol1=(holByDay[ky1]||[]),hol2=(holByDay[ky2]||[]);var g='<div class="grid">';g+='<div class="cell head lesson">שיעור</div>';g+='<div class="cell head" style="background:'+headBg(d1)+'"><b>'+dayNames[d1.getDay()]+'</b><br>'+fmt(d1)+(hol1.length?('<div style="font-size:12px;margin-top:4px">'+hol1.join('<br>')+'</div>'):'')+'</div>';g+='<div class="cell head" style="background:'+headBg(d2)+'"><b>'+dayNames[d2.getDay()]+'</b><br>'+fmt(d2)+(hol2.length?('<div style="font-size:12px;margin-top:4px">'+hol2.join('<br>')+'</div>'):'')+'</div>';for(var r=0;r<lessons.length;r++){var les=lessons[r];var baseA=(baseGrid[d1.getDay()]&&baseGrid[d1.getDay()][les])?baseGrid[d1.getDay()][les]:'',baseB=(baseGrid[d2.getDay()]&&baseGrid[d2.getDay()][les])?baseGrid[d2.getDay()][les]:'';var plansA=(plansByDay[ky1]&&plansByDay[ky1][les])?plansByDay[ky1][les]:[];var plansB=(plansByDay[ky2]&&plansByDay[ky2][les])?plansByDay[ky2][les]:[];g+='<div class="cell lesson" style="font-weight:600">'+les+'</div>';g+='<div class="cell" style="background:'+cellBg(d1)+'">'+mk(baseA,plansA)+'</div>';g+='<div class="cell" style="background:'+cellBg(d2)+'">'+mk(baseB,plansB)+'</div>';}g+='</div>';return g;}var radios='';for(var i=0;i<pairStarts.length;i++){radios+='<input type="radio" name="'+rid+'_r" id="'+rid+'_p'+i+'" '+(i===def?'checked':'')+' style="display:none">';}var view='<div class="mx-view">';for(var i=0;i<pairStarts.length;i++){var s=pairStarts[i],d1=days[s],d2=days[s+1];view+='<div class="pair pair-'+i+'">'+gridFor(d1,d2)+'</div>';}view+='</div>';var nav='<div class="mx-nav">';for(var i=0;i<pairStarts.length;i++){var prev=(i>0?i-1:null),next=(i<pairStarts.length-1?i+1:null);nav+=(prev!==null?'<label class="mx-btn prev-'+i+'" for="'+rid+'_p'+prev+'">«</label>':'')+(next!==null?'<label class="mx-btn next-'+i+'" for="'+rid+'_p'+next+'">»</label>':'');}nav+='</div>';return '<div dir="rtl" class="mx-wrap"><h3 class="mx-head">מערכת שעות + תכנון שבועי — '+student+'</h3><div class="mx-frame">'+css+radios+view+nav+'</div></div>';})()}
