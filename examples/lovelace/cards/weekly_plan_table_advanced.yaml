# --------------------------------------------
# Mashov – Weekly timetable + plan + holidays (template)
# --------------------------------------------
# WHAT THIS CARD DOES
# - Base grid from the student's TIMETABLE (day+lesson → subject/teacher).
# - Joins the WEEKLY PLAN sensor by matching day+lesson and shows "תכנון לשיעור".
# - Marks HOLIDAY dates (from sensor.mashov_holidays) with red header and soft red cells,
#   and prints holiday name(s) under the date.
# - RTL, Sunday-first, lesson numbers are the rows, current day highlighted.
#
# HOW TO USE / WHAT TO CHANGE
# - Replace <studentID> in BOTH entity IDs below:
#     sensor.mashov_<studentID>_timetable
#     sensor.mashov_<studentID>_weekly_plan
# - If your holidays sensor has a different id, change sensor.mashov_holidays accordingly.
#
# DEPENDENCIES (Lovelace resources)
# - custom:config-template-card   (HACS)  → add resource, then use type: module
# - custom:html-card              (HACS)  → add resource, then use type: module
#   In Settings → Dashboards → Resources, you should have e.g.:
#   /hacsfiles/config-template-card/config-template-card.js  (module)
#   /hacsfiles/html-card/html-card.js                        (module)
#
# DATA EXPECTED
# - Timetable sensor attributes: Items[].timeTable.{day(1-7), lesson}, groupDetails.{subjectName, groupTeachers[].teacherName}
# - Weekly plan sensor attributes: Items[].{lesson_date (ISO), lesson, plan}
# - Holidays sensor attributes: Items[].{name, start(ISO), end(ISO)}; ranges are inclusive of both dates.
#
type: custom:config-template-card
entities:
  # >>> CHANGE <studentID> HERE <<<
  - sensor.mashov_<studentID>_timetable
  # >>> CHANGE <studentID> HERE <<<
  - sensor.mashov_<studentID>_weekly_plan
  # Change if your holidays sensor has a different id
  - sensor.mashov_holidays
card:
  type: custom:html-card
  content: >-
    ${(function(){var ttId='sensor.mashov_<studentID>_timetable',wpId='sensor.mashov_<studentID>_weekly_plan',holId='sensor.mashov_holidays',tt=states[ttId],wp=states[wpId],hol=states[holId];if(!tt||!tt.attributes){return '<div dir="rtl" style="text-align:right;padding:8px;opacity:.8;">אין נתונים להצגה (מערכת שעות)</div>'; }var student=(tt.attributes.student_name||tt.attributes['Student name']||tt.attributes.full_name||tt.attributes.name||(tt.attributes.friendly_name||'').trim()||'שם תלמיד/ה');var ttItems=Array.isArray(tt.attributes.Items||tt.attributes.items)?(tt.attributes.Items||tt.attributes.items):[];var wpItems=(wp&&wp.attributes&&Array.isArray(wp.attributes.Items||wp.attributes.items))?(wp.attributes.Items||wp.attributes.items):[];var holItems=(hol&&hol.attributes&&Array.isArray(hol.attributes.Items||hol.attributes.items))?(hol.attributes.Items||hol.attributes.items):[];function pad(n){return String(n).padStart(2,'0');}function fmtDDMMYYYY(d){return pad(d.getDate())+'/'+pad(d.getMonth()+1)+'/'+d.getFullYear();}function ymd(d){return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate());}function atMid(d){return new Date(d.getFullYear(),d.getMonth(),d.getDate(),0,0,0,0);}var today=new Date();var dow=today.getDay();var start=new Date(today.getFullYear(),today.getMonth(),today.getDate()-dow);var days=[];for(var i=0;i<7;i++){var d=new Date(start);d.setDate(start.getDate()+i);days.push(d);}var dayNames=['ראשון','שני','שלישי','רביעי','חמישי','שישי','שבת'];var baseGrid={},lessonSet={};for(var k=0;k<ttItems.length;k++){var it=ttItems[k]||{};var t=it.timeTable||it.timetable||{};var di=(parseInt(t.day,10)||0)-1;if(di<0||di>6)continue;var les=(t.lesson!=null?String(t.lesson):'');if(!les)continue;var gd=it.groupDetails||{};var subj=(gd.subjectName||gd.groupName||'');var teacher=((gd.groupTeachers&&gd.groupTeachers[0]&&gd.groupTeachers[0].teacherName)||'');var label=subj?('<b>'+subj+'</b>'+(teacher?'<br>'+teacher:'')):(teacher||'');baseGrid[di]=baseGrid[di]||{};baseGrid[di][les]=label;lessonSet[les]=true;}var lessonKeys=Object.keys(lessonSet).map(function(x){return parseInt(x,10)}).filter(function(x){return !isNaN(x)}).sort(function(a,b){return a-b}).map(String);if(!lessonKeys.length){return '<div dir="rtl" style="text-align:right;padding:8px;opacity:.8;">אין מערכת שעות להצגה</div>'; }var planGrid={};for(var p=0;p<wpItems.length;p++){var w=wpItems[p]||{};var dtStr=w.lesson_date||w.date||'';if(!dtStr)continue;var dt=new Date(dtStr);var inRange=dt>=new Date(days[0].getFullYear(),days[0].getMonth(),days[0].getDate(),0,0,0,0)&&dt<new Date(days[6].getFullYear(),days[6].getMonth(),days[6].getDate(),23,59,59,999);if(!inRange)continue;var di2=-1;for(var dIdx=0;dIdx<7;dIdx++){if(dt.getFullYear()===days[dIdx].getFullYear()&&dt.getMonth()===days[dIdx].getMonth()&&dt.getDate()===days[dIdx].getDate()){di2=dIdx;break;}}if(di2<0)continue;var les2=(w.lesson!=null?String(w.lesson):'');if(!les2)continue;var plan=(w.plan!=null?String(w.plan):'');if(!plan)continue;planGrid[di2]=planGrid[di2]||{};planGrid[di2][les2]=planGrid[di2][les2]||[];planGrid[di2][les2].push(plan);}var holidayByYmd={};for(var h=0;h<holItems.length;h++){var hItem=holItems[h]||{};var nm=hItem.name||'';var st=hItem.start?new Date(hItem.start):null;var en=hItem.end?new Date(hItem.end):null;if(!st||!en)continue;st=atMid(st);en=atMid(en);for(var dI=0;dI<7;dI++){var x=atMid(days[dI]);if(x>=st&&x<=en){var key=ymd(x);holidayByYmd[key]=holidayByYmd[key]||[];if(nm&&!holidayByYmd[key].includes(nm))holidayByYmd[key].push(nm);}}}var hi=dow;var out='<div dir="rtl" style="text-align:right;"><h3 style="margin:0 0 8px;font-size:16px;">מערכת שעות + תכנון שבועי — '+student+'</h3><div style="border:1px solid rgba(0,0,0,.08);border-radius:10px;overflow:hidden;"><table style="width:100%;border-collapse:collapse;direction:rtl;text-align:right;"><thead><tr style="background:rgba(0,0,0,.03);"><th style="padding:10px 12px;border-bottom:1px solid rgba(0,0,0,.08);white-space:nowrap;">שיעור</th>';for(var c=0;c<7;c++){var dStr=ymd(days[c]);var holNames=holidayByYmd[dStr]||[];var isHol=holNames.length>0;var isToday=(c===hi);var extra=(isHol?('<div style="margin-top:4px;font-size:12px;font-weight:600;">'+holNames.join('<br>')+'</div>'):'');var label='<div>'+dayNames[c]+'<br>'+fmtDDMMYYYY(days[c])+extra+'</div>';var headBg=isHol?'background:rgba(244,67,54,.35);':(isToday?'background:rgba(255,235,59,.25);':'');out+='<th style="padding:10px 12px;border-bottom:1px solid rgba(0,0,0,.08);white-space:nowrap;'+headBg+'">'+label+'</th>';}out+='</tr></thead><tbody>';for(var li=0;li<lessonKeys.length;li++){var lesK=lessonKeys[li];out+='<tr style="border-bottom:1px solid rgba(0,0,0,.06);"><td style="padding:10px 12px;font-weight:600;vertical-align:top;white-space:nowrap;">'+lesK+'</td>';for(var c2=0;c2<7;c2++){var dStr2=ymd(days[c2]);var isHol2=(holidayByYmd[dStr2]||[]).length>0;var base=(baseGrid[c2]&&baseGrid[c2][lesK])?baseGrid[c2][lesK]:'';var plans=(planGrid[c2]&&planGrid[c2][lesK])?planGrid[c2][lesK]:[];var cell='';if(base){cell+='<div>'+base+'</div>';}if(plans.length===1){cell+='<div style="margin-top:4px;"><b>תכנון לשיעור:</b><br>'+plans[0]+'</div>';}else if(plans.length>1){cell+='<div style="margin-top:4px;"><b>תכנון לשיעור:</b><br>• '+plans.join('<br>• ')+'</div>';}if(!cell)cell='&nbsp;';var cellBg=isHol2?'background:rgba(244,67,54,.18);':(c2===hi?'background:rgba(255,235,59,.15);':'');out+='<td style="padding:10px 12px;vertical-align:top;'+cellBg+'">'+cell+'</td>';}out+='</tr>';}out+='</tbody></table></div></div>';return out;})()}
